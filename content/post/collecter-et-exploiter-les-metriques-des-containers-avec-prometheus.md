+++
categories = ["Docker","Prometheus"]
tags = ["Docker","Prometheus"]
image = "/images/2016/11/prometheus.png"
draft = true
title = "Collecter et exploiter les métriques des containers avec Prometheus"
date = 2016-11-23T09:28:21Z
author = "MrRaph_"
description = ""
slug = "collecter-et-exploiter-les-metriques-des-containers-avec-prometheus"

+++




## CAdvisor 1
docker service create --replicas 1 --network back-tier \
--restart-condition any --name cadvisor-1 \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/var/run,target=/var/run \
--mount type=bind,source=/sys,target=/sys,ro=true \
--mount type=bind,source=/var/lib/docker,target=/var/lib/docker,ro=true \
--constraint 'node.hostname == docker-machine-1' \
google/cadvisor

## CAdvisor 2
docker service create --replicas 1 --network back-tier \
--restart-condition any --name cadvisor-2 \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/var/run,target=/var/run \
--mount type=bind,source=/sys,target=/sys,ro=true \
--mount type=bind,source=/var/lib/docker,target=/var/lib/docker,ro=true \
--mount type=bind,source=/etc/hostname,target=/etc/hostname,ro=true \
--mount type=bind,source=/var/log/syslog,target=/var/log/syslog,ro=true \
--constraint 'node.hostname == docker-machine-2' \
google/cadvisor

## CAdvisor 3
docker service create --replicas 1 --network back-tier \
--restart-condition any --name cadvisor-3 \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/var/run,target=/var/run \
--mount type=bind,source=/sys,target=/sys,ro=true \
--mount type=bind,source=/var/lib/docker,target=/var/lib/docker,ro=true \
--constraint 'node.hostname == docker-machine-3' \
google/cadvisor

## Node Exporter 1
docker service create --replicas 1 --network back-tier \
--restart-condition any --name node-exporter-1 \
--constraint 'node.hostname == docker-machine-1' \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/sys,target=/host/sys,ro=true \
--mount type=bind,source=/proc,target=/host/proc,ro=true \
prom/node-exporter --collector.filesystem.ignored-mount-points "^/(sys|proc|dev|host|etc)($|/)" \
--collector.procfs /host/proc --collector.sysfs /host/proc \
--collectors.enabled="conntrack,diskstats,entropy,filefd,ksmd,loadavg,mdadm,meminfo,meminfo_numa,netdev,netstat,sockstat,stat,filesystem,time,vmstat,tcpstat"

## Node Exporter 2
docker service create --replicas 1 --network back-tier \
--mount type=bind,source=/etc/hostname,target=/etc/hostname,ro=true \
--restart-condition any --name node-exporter-2 \
--constraint 'node.hostname == docker-machine-2' \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/sys,target=/host/sys,ro=true \
--mount type=bind,source=/proc,target=/host/proc,ro=true \
prom/node-exporter --collector.filesystem.ignored-mount-points "^/(sys|proc|dev|host|etc)($|/)" \
--collector.procfs /host/proc --collector.sysfs /host/proc \
--collectors.enabled="conntrack,diskstats,entropy,filefd,ksmd,loadavg,mdadm,meminfo,meminfo_numa,netdev,netstat,sockstat,stat,filesystem,time,vmstat,tcpstat"

## Node Exporter 3
docker service create --replicas 1 --network back-tier \
--restart-condition any --name node-exporter-3 \
--constraint 'node.hostname == docker-machine-3' \
--mount type=bind,source=/,target=/rootfs,ro=true \
--mount type=bind,source=/sys,target=/host/sys,ro=true \
--mount type=bind,source=/proc,target=/host/proc,ro=true \
prom/node-exporter --collector.filesystem.ignored-mount-points "^/(sys|proc|dev|host|etc)($|/)" \
--collector.procfs /host/proc --collector.sysfs /host/proc \
--collectors.enabled="conntrack,diskstats,entropy,filefd,ksmd,loadavg,mdadm,meminfo,meminfo_numa,netdev,netstat,sockstat,stat,filesystem,time,vmstat,tcpstat"

## Alert Manager
docker service create --network back-tier \
--restart-condition any --name alertmanager \
--mount type=bind,source=/data/tools/prometheus/alertmanager/,target=/etc/alertmanager/ \
prom/alertmanager -config.file=/etc/alertmanager/config.yml -storage.path=/alertmanager

## Fluentd
docker service create --network back-tier --publish 24224:24224 \
--restart-condition any --name fluentd \
--mount type=bind,source=/data/tools/fluentd/fluentd-docker.pos,target=/var/log/fluentd-docker.pos \
--mount type=bind,source=/data/tools/fluentd/fluentd.conf,target=/fluentd/etc/fluentd.conf \
--mount type=bind,source=/var/lib/docker/containers/,target=/var/lib/docker/containers/,ro=true \
--env FLUENTD_CONF=fluentd.conf \
--env FLUENTD_OPT=qsdfAZG21 \
mrraph/fluentd fluentd -c /fluentd/etc/fluentd.conf

## Prometheus
#--mount type=bind,source=/data/tools/prometheus/prometheus,target=/prometheus \
docker service create --network back-tier \
--restart-condition any --name prometheus \
--mount type=bind,source=/data/tools/prometheus/prometheus/,target=/etc/prometheus/ \
--mount type=volume,source=prometheus_data,target=/prometheus,volume-driver=glusterfs \
prom/prometheus -config.file=/etc/prometheus/prometheus.yml -storage.local.path=/prometheus/data \
-alertmanager.url=http://alertmanager:9093 -storage.local.retention=372h

## Graphana
docker service create --network back-tier --network web \
--restart-condition any --name grafana \
--mount type=volume,source=grafana_data,target=/var/lib/grafana,volume-driver=glusterfs \
--env GF_SECURITY_ADMIN_PASSWORD=qsdfAZG21 \
--env GF_USERS_ALLOW_SIGN_UP=false \
--env GF_SERVER_ROOT_URL=https://monitoring.aldanet.fr \
--label="traefik.backend=grafana" \
--label="traefik.backend.grafana.loadbalancer.sticky=true" \
--label="traefik.backend.grafana.loadbalancer.method=drr" \
--label="traefik.frontend.rule=Host:monitoring.aldanet.fr" \
--label="traefik.port=3000" \
--label="traefik.docker.network=web" \
grafana/grafana 

## Traefik exporter
docker service create --network back-tier --network web \
--restart-condition any --name traefik-exporter-1 \
mrraph/traefik-exporter app -traefik.address http://traefik-1:8080/health

docker service create --network back-tier --network web \
--restart-condition any --name traefik-exporter-2 \
mrraph/traefik-exporter app -traefik.address http://traefik-2:8080/health

docker service create --network back-tier --network web \
--restart-condition any --name traefik-exporter-3 \
mrraph/traefik-exporter app -traefik.address http://traefik-3:8080/health




[Docker Containers - Dashboard](https://techan.fr/images/grafana_dashboard/Docker_Containers-1479893053520.json)